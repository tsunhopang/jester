name: Claude Code - PR Review

# This workflow provides on-demand PR reviews by Claude when explicitly requested.
# Usage: Comment "@claude" on a PR to trigger a review
# Focus: Python/JAX code, scientific computing, and physics validation
# Note: Claude has access to pytest and can run tests to verify changes

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Only run when @claude is mentioned in a PR comment
    if: |
      github.event.issue.pull_request &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
      )

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Changed from read to write to allow posting comments
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request for JESTER (JAX-based EoS and TOV solver), focusing on:

            **Python/JAX Best Practices:**
            - Proper use of JAX transformations (jit, grad, vmap, etc.)
            - Avoiding Python side effects in JAX-compiled code
            - Correct array shape annotations with jaxtyping
            - 64-bit precision requirements for numerical accuracy

            **Scientific Computing Concerns:**
            - Numerical stability and precision
            - Geometric units consistency
            - Physical validity of calculations (TOV equations, EOS models)
            - Test coverage with realistic physics parameters

            **Code Quality:**
            - Type safety (pyright compliance)
            - Code formatting (black, ruff)
            - Documentation quality (especially LaTeX in docstrings using raw strings)
            - Performance considerations

            **Testing:**
            - Run relevant tests with pytest to verify changes don't break existing functionality
            - Check that new physics code has appropriate test coverage

            Use the repository's CLAUDE.md for detailed guidance on testing philosophy,
            common pitfalls (e.g., MetaModel EOS density limits, geometric units),
            and development conventions.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(pytest:*),Bash(python:*),Bash(pyright:*)"'

